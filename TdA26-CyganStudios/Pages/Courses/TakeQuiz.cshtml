@page "/courses/{courseUuid}/quiz_take"
@model TdA26_CyganStudios.Pages.Courses.TakeQuizModel

@{
    ViewData["Title"] = Model.Quiz?.Title ?? "Quiz";
}

<div class="container mt-4">
    <h2 class="mb-4">@Model.Quiz.Title</h2>

    @if (Model.Score is not null)
    {
        <div class="alert alert-success">
            <strong>Score:</strong> @Model.Score / @Model.Quiz.Questions.Sum(q => q.CorrectIndices.Count())
        </div>

        <div class="mb-3">
            <span class="badge bg-success">Correct</span>
            <span class="badge bg-danger">Wrong</span>
            <span class="badge bg-warning text-dark">Missed</span>
        </div>
    }

    <form method="post">
        @for (int i = 0; i < Model.Quiz.Questions.Count; i++)
        {
            var q = Model.Quiz.Questions[i];

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        @(i + 1). @q.Question
                    </h5>

                    <input type="hidden" name="Answers[@i].QuestionIndex" value="@i" />

                    @if (Model.Score is null)
                    {
                        @if (q.IsMultiChoice)
                        {
                            <div class="text-muted mb-2">
                                Select <strong>@q.CorrectIndices.Count()</strong> answers
                            </div>
                        }
                    }
                    else
                    {
                        int correctCount = 0;
                        for (int o = 0; o < q.Options.Count(); o++)
                        {
                            if (q.CorrectIndices.Contains(o))
                            {
                                correctCount++;
                            }
                        }

                        <p>@correctCount/@q.CorrectIndices.Count()</p>
                    }

                    @for (int o = 0; o < q.Options.Count(); o++)
                    {
                        bool isCorrect = q.CorrectIndices.Contains(o);
                        bool isSelected = Model.Score != null && Model.IsOptionSelected(i, o);
                        var inputType = q.IsMultiChoice ? "checkbox" : "radio";
                        var name = $"Answers[{i}].SelectedIndices";

                        string highlight = "";

                        if (Model.Score != null)
                        {
                            if (isCorrect && isSelected)
                                highlight = "border-success bg-success bg-opacity-10";
                            else if (!isCorrect && isSelected)
                                highlight = "border-danger bg-danger bg-opacity-10";
                            else if (isCorrect && !isSelected)
                                highlight = "border-warning bg-warning bg-opacity-10";
                        }

                        <div class="flex gap form-check p-2 rounded border @highlight">
                            <input class="form-check-input quiz-option" type="@inputType" name="@name" value="@o" id="q@i-o@o"
                                   data-question="@i" data-max="@(q.IsMultiChoice? q.CorrectIndices.Count() : 1)" @(Model.Score is not null ? "disabled" : "") @(Model.Score is not null && Model.IsOptionSelected(i, o) ? "checked" : "") />

                            <label class="form-check-label" for="q@i-o@o">
                                @q.Options.ElementAt(o)
                            </label>
                        </div>
                    }

                    @if (Model.Score != null)
                    {
                        <div class="mt-3">
                            <strong>Correct answer@(q.CorrectIndices.Skip(1).Any() ? "s" : ""):</strong>
                            @string.Join(", ", q.CorrectIndices.Select(idx => q.Options.ElementAt(idx)))
                        </div>
                    }
                </div>
            </div>
        }

        @if (Model.Score is null)
        {
            <button type="submit" class="btn btn-primary">
                Submit Quiz
            </button>
        }
        else
        {
            <a class="btn btn-outline-secondary mb-4" asp-page="/Courses/Details" asp-route-courseUuid="@Model.CourseUuid">
                ‚Üê Back to course
            </a>
        }
    </form>
</div>

@section Scripts {
    <script>
        // make sure there aren't more selected options than there are correct options
        document.querySelectorAll('.quiz-option[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', e => {
                const current = e.target;
                const q = current.dataset.question;
                const max = parseInt(current.dataset.max);

                const checked = Array.from(
                    document.querySelectorAll(
                        `.quiz-option[type="checkbox"][data-question="${q}"]:checked`
                    )
                );

                if (checked.length > max) {
                    const toUncheck = checked.find(x => x !== current);

                    if (toUncheck) {
                        toUncheck.checked = false;
                    }
                }
            });
        });

        // warn if not all options are selected
        document.querySelector('form').addEventListener('submit', e => {
            let incomplete = false;

            document.querySelectorAll('.card').forEach(card => {
                const inputs = card.querySelectorAll('.quiz-option');
                const checked = card.querySelectorAll('.quiz-option:checked');
                const max = parseInt(inputs[0].dataset.max);

                if (checked.length === 0)
                    incomplete = true;

                if (inputs[0].type === "checkbox" && checked.length !== max)
                    incomplete = true;
            });

            if (incomplete) {
                e.preventDefault();

                if (confirm("Some questions are incomplete. Do you still want to submit?")) {
                    e.target.submit();
                }
            }
        });
    </script>
}
