@page "/dashboard/course/{courseUuid}/materials"
@using TdA26_CyganStudios.Models.Db
@using TdA26_CyganStudios.Utils
@model TdA26_CyganStudios.Pages.Dashboard.Course.MaterialsModel
@{
	ViewData["Title"] = "Materials";
}

<div class="mt-4 p-3 rounded bg-light bg-opacity-75 dark:bg-dark dark:bg-opacity-75">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<div class="d-flex align-items-center gap-3">
			<h3 class="mb-0">Materials</h3>

			<div class="dropdown">
				<button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown"
					aria-expanded="false">
					+ New
				</button>
				<ul class="dropdown-menu">
					<li>
						<a class="dropdown-item" asp-page="/Dashboard/Course/NewFileMaterial"
							asp-route-courseUuid="@Model.CourseUuid">File Material</a>
					</li>
					<li>
						<a class="dropdown-item" asp-page="/Dashboard/Course/NewUrlMaterial"
							asp-route-courseUuid="@Model.CourseUuid">URL Material</a>
					</li>
				</ul>
			</div>
		</div>
	</div>

	<div class="container-fluid px-0">
		@{
			var materialsToShow = Model.Course.Materials.OrderByDescending(material => material.CreatedAt);
			var totalMaterials = Model.Course.Materials.Count;
		}
		<div class="d-flex flex-wrap gap-3 align-items-stretch">
			@if (totalMaterials == 0)
			{
				<div class="col-12">
					<div class="card text-center py-5">
						<div class="card-body">
							<i class="bi bi-folder-x h1 text-muted"></i>
							<h5 class="mt-3 mb-1">No Materials Yet</h5>
							<p class="text-muted mb-0">Add materials to get started.</p>
						</div>
					</div>
				</div>
			}
			else
			{
				@foreach (var material in materialsToShow)
				{
					<div class="card h-100 flex-fill bg-white dark:bg-secondary text-dark dark:text-light"
						style="min-width: 18rem; max-width: 22rem; position: relative;">
						<div class="dropdown position-absolute top-0 end-0 m-2">
							<button class="btn btn-sm bg-body-secondary p-1 text-muted" type="button" data-bs-toggle="dropdown"
								aria-expanded="false" style="line-height: 1;">
								<i class="bi bi-three-dots-vertical"></i>
							</button>

							<ul class="dropdown-menu dropdown-menu-end">
								<li>
									<a class="dropdown-item" asp-page="/Dashboard/MaterialEdit"
										asp-route-courseUuid="@Model.CourseUuid" asp-route-materialUuid="@material.Uuid">
										<i class="bi bi-pencil-square"></i> Edit
									</a>
								</li>
								<li>
									<form method="post" asp-page-handler="Delete" asp-route-materialUuid="@material.Uuid"
										onsubmit="return confirm('Are you sure you want to delete this material?');">
										<button type="submit" class="dropdown-item text-danger">
											<i class="bi bi-trash"></i> Delete
										</button>
									</form>
								</li>
							</ul>
						</div>

						<div class="card-body">
							<h5 class="card-title mb-1">@material.Name</h5>
							<p class="card-text text-muted mb-2">@material.Description</p>

							@if (material is DbUrlMaterial url)
							{
								<div class="d-flex align-items-center gap-2 mt-1">
									<img src="https://www.google.com/s2/favicons?domain=@(new Uri(url.Url).Host)&sz=32"
										alt="favicon" width="16" height="16" class="rounded" />
									<a href="@url.Url" target="_blank" class="card-link">
										Open
									</a>
								</div>
							}
							else if (material is DbFileMaterial file)
							{
								<div class="d-flex flex-wrap align-items-center gap-2 mt-1">
									<span class="px-2 py-1 small text-muted border rounded-pill">
										@FileSize.ToString(file.SizeInBytes)
									</span>

									@if (file.IsPreviewable)
									{
										<a href="/api/courses/@(material.CourseId)/materials/@(material.Uuid)/preview" target="_blank"
											class="card-link d-flex align-items-center gap-1">
											<i class="bi bi-eye"></i>
											Preview
										</a>
									}

									<a href="/api/courses/@(material.CourseId)/materials/@(material.Uuid)/download"
										class="card-link d-flex align-items-center gap-1">
										<i class="bi bi-download"></i>
										Download
									</a>
								</div>
							}
						</div>

					</div>
				}
			}
		</div>
	</div>
</div>